global
    daemon
    maxconn 4096
    log stdout local0
    
    # Performance
    nbthread 4
    cpu-map auto:1/1-4 0-3

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option log-health-checks
    
    # Timeouts
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    timeout http-request 15s
    timeout http-keep-alive 15s
    
    # Health checks
    option httpchk GET /health

# Statistics page
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
    stats show-legends
    stats show-node

# Main frontend for API traffic - PRODUCTION READY
frontend cybersec-api-frontend
    bind *:80
    
    # Security headers
    http-response set-header X-Frame-Options DENY
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"
    http-response set-header Referrer-Policy "strict-origin-when-cross-origin"
    
    # CORS handling for API
    http-response add-header Access-Control-Allow-Origin "*"
    http-response add-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-response add-header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    
    # Handle preflight requests
    acl is_options method OPTIONS
    http-request return status 200 if is_options
    
    # Route to backend
    default_backend cybersec-api-backend

# Backend configuration
backend cybersec-api-backend
    balance roundrobin
    
    # Health check configuration
    option httpchk GET /health
    http-check expect status 200
    
    # Server configuration with proper hostnames
    server fastapi-1 cybersecurity-api-1:8080 check inter 30s rise 2 fall 3 weight 100
    server fastapi-2 cybersecurity-api-2:8080 check inter 30s rise 2 fall 3 weight 100
    server fastapi-3 cybersecurity-api-3:8080 check inter 30s rise 2 fall 3 weight 100
    
    # Connection settings
    option prefer-last-server
    option http-server-close
    option forwardfor
    
    # Compression
    compression algo gzip
    compression type text/html text/plain text/css text/javascript application/json application/javascript
